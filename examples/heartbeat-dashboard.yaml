# ============================================================
# heartbeat-dashboard.yaml — Push Heartbeat Data to a Dashboard
# ============================================================
#
# WHAT IT DOES:
#   Hooks into heartbeat events to log structured health data
#   and push results to an external webhook/API after each
#   heartbeat cycle completes.
#
#   Uses exec_script hooks to call a push script that sends
#   heartbeat data to your dashboard or monitoring system.
#
# WHY IT MATTERS:
#   Heartbeat hooks let you:
#     - Monitor agent liveness from external systems
#     - Track session activity and stall detection
#     - Push metrics to Prometheus, Grafana, Datadog, etc.
#     - Alert on heartbeat failures or missed cycles
#
# HOW TO USE:
#   1. cp examples/heartbeat-dashboard.yaml HOOKS.yaml
#   2. Create hooks/push-heartbeat.sh (see template below)
#   3. chmod +x hooks/push-heartbeat.sh
#   4. Set DASHBOARD_URL in your environment or edit the script
#
# SCRIPT TEMPLATE (hooks/push-heartbeat.sh):
#   #!/usr/bin/env bash
#   curl -s -X POST "$DASHBOARD_URL/heartbeat" \
#     -H "Content-Type: application/json" \
#     -H "Authorization: Bearer $DASHBOARD_TOKEN" \
#     -d "{
#       \"point\": \"$HOOK_POINT\",
#       \"session\": \"$HOOK_SESSION\",
#       \"timestamp\": $HOOK_TIMESTAMP,
#       \"topic\": \"$HOOK_TOPIC\"
#     }" || exit 1
#   exit 0
#
# ENVIRONMENT VARIABLES available in hook scripts:
#   HOOK_POINT      — e.g. "heartbeat:post"
#   HOOK_SESSION    — full session key
#   HOOK_TOPIC      — forum topic ID (if applicable)
#   HOOK_TIMESTAMP  — unix ms timestamp
#   HOOK_SUBAGENT   — "true" or "false"
#   (plus all existing environment variables)
#
# ============================================================

version: "1"

defaults:
  # Heartbeat hooks are observability — never block the pipeline.
  onFailure:
    action: continue
    notifyUser: false

hooks:
  # ──────────────────────────────────────────────────────────────
  # LOG: Heartbeat start (for local record)
  #
  # Records each heartbeat cycle start to a JSONL file.
  # Useful for tracking heartbeat frequency and detecting gaps.
  # ──────────────────────────────────────────────────────────────
  - point: heartbeat:pre
    action: log
    target: "memory/logs/heartbeats.jsonl"
    onFailure:
      action: continue

  # ──────────────────────────────────────────────────────────────
  # LOG: Heartbeat completion (with timing data)
  #
  # Records heartbeat:post — you can diff timestamps between
  # heartbeat:pre and heartbeat:post to measure cycle duration.
  # ──────────────────────────────────────────────────────────────
  - point: heartbeat:post
    action: log
    target: "memory/logs/heartbeats.jsonl"
    onFailure:
      action: continue

  # ──────────────────────────────────────────────────────────────
  # PUSH: Heartbeat data to external dashboard (exec_script)
  #
  # Runs hooks/push-heartbeat.sh after each heartbeat completes.
  # The script receives all context via environment variables.
  #
  # Exit 0 = success; non-zero = failure (triggers onFailure).
  # Since onFailure is `continue`, a push failure won't block
  # the agent — just logs a warning.
  # ──────────────────────────────────────────────────────────────
  - point: heartbeat:post
    action: exec_script
    target: "hooks/push-heartbeat.sh"
    onFailure:
      action: continue
      notifyUser: false

  # ──────────────────────────────────────────────────────────────
  # PUSH: Heartbeat to uptime monitoring (e.g. UptimeRobot)
  #
  # Many uptime monitors accept a GET request to a "ping" URL.
  # Create a simple wrapper script for this:
  #
  # hooks/ping-uptime.sh:
  #   #!/usr/bin/env bash
  #   curl -fsS "$UPTIME_PING_URL" > /dev/null || exit 1
  #   exit 0
  # ──────────────────────────────────────────────────────────────
  - point: heartbeat:post
    action: exec_script
    target: "hooks/ping-uptime.sh"
    enabled: false   # Enable once you've created the script
    onFailure:
      action: continue
      notifyUser: false

  # ──────────────────────────────────────────────────────────────
  # SUMMARIZE: Heartbeat status for human review (Optional)
  #
  # Summarizes heartbeat metadata using an LLM and appends
  # to a readable status log. Useful if heartbeat metadata
  # includes rich state (e.g. queue depth, active tasks).
  #
  # Cost: 1 LLM call per heartbeat cycle — use sparingly.
  # Disable if heartbeats fire frequently.
  # ──────────────────────────────────────────────────────────────
  - point: heartbeat:post
    action: summarize_and_log
    model: anthropic/claude-haiku-4-5
    target: "memory/logs/heartbeat-summaries.jsonl"
    enabled: false   # Enable only if you need LLM-generated summaries
    onFailure:
      action: continue
