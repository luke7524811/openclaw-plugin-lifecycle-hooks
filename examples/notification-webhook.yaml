# ============================================================
# notification-webhook.yaml â€” Slack / Discord Webhook Alerts
# ============================================================
#
# WHAT IT DOES:
#   Fires webhook notifications to Slack or Discord on key
#   agent lifecycle events:
#     - When a turn completes (agent responded)
#     - When a sub-agent is spawned
#     - When a sub-agent completes
#     - When a dangerous command is blocked
#     - When a cron job runs
#
#   Uses exec_script hooks pointing to a webhook dispatch script.
#
# HOW TO USE:
#   1. cp examples/notification-webhook.yaml HOOKS.yaml
#   2. Create hooks/notify-slack.sh (template below)
#   3. chmod +x hooks/notify-slack.sh
#   4. Set SLACK_WEBHOOK_URL (or DISCORD_WEBHOOK_URL) in env
#
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# SLACK SCRIPT TEMPLATE (hooks/notify-slack.sh):
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#   #!/usr/bin/env bash
#   PAYLOAD=$(jq -n \
#     --arg text "*[$HOOK_POINT]* Session: \`$HOOK_SESSION\`\nTool: \`$HOOK_TOOL\`" \
#     '{"text": $text}')
#   curl -s -X POST "$SLACK_WEBHOOK_URL" \
#     -H "Content-Type: application/json" \
#     -d "$PAYLOAD" || exit 1
#   exit 0
#
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# DISCORD SCRIPT TEMPLATE (hooks/notify-discord.sh):
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#   #!/usr/bin/env bash
#   PAYLOAD=$(jq -n \
#     --arg content "**[$HOOK_POINT]** \`$HOOK_TOOL\` â€” $HOOK_SESSION" \
#     '{"content": $content}')
#   curl -s -X POST "$DISCORD_WEBHOOK_URL" \
#     -H "Content-Type: application/json" \
#     -d "$PAYLOAD" || exit 1
#   exit 0
#
# ENVIRONMENT VARIABLES available in hook scripts:
#   HOOK_POINT          â€” e.g. "turn:post"
#   HOOK_SESSION        â€” full session key
#   HOOK_TOOL           â€” tool name (for tool hooks)
#   HOOK_ARGS           â€” JSON-encoded tool arguments
#   HOOK_TOPIC          â€” forum topic ID
#   HOOK_TIMESTAMP      â€” unix ms timestamp
#   HOOK_SUBAGENT       â€” "true" or "false"
#   HOOK_SUBAGENT_LABEL â€” sub-agent label
#   HOOK_CRON_JOB       â€” cron job name (for cron hooks)
#   HOOK_PROMPT         â€” user prompt (for turn:pre)
#
# ============================================================

version: "1"

defaults:
  # Webhooks are fire-and-forget â€” never block the pipeline.
  onFailure:
    action: continue
    notifyUser: false

hooks:
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # NOTIFY: Turn completed (agent responded)
  #
  # Fires after each turn completes. Good for awareness of
  # agent activity without being in the chat.
  #
  # High-volume: every response fires this. Enable selectively
  # (e.g., use `match.topicId` to limit to specific topics).
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - point: turn:post
    action: exec_script
    target: "hooks/notify-slack.sh"
    enabled: false   # High volume â€” enable only if needed
    onFailure:
      action: continue

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # NOTIFY: Sub-agent spawned
  #
  # Useful when you want to know when the main agent delegates
  # to a sub-agent (can indicate a complex task started).
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - point: subagent:spawn:pre
    action: exec_script
    target: "hooks/notify-slack.sh"
    onFailure:
      action: continue

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # NOTIFY: Sub-agent completed
  #
  # Fires when a sub-agent finishes. Pairs with spawn:pre to
  # bracket the duration of a delegated task.
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - point: subagent:post
    action: exec_script
    target: "hooks/notify-slack.sh"
    onFailure:
      action: continue

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # NOTIFY: Dangerous command BLOCKED (high priority)
  #
  # When a command is blocked, the block action returns passed=false
  # and halts the pipeline. We can't fire a webhook inside the
  # block action itself, but we CAN add a second hook for the
  # same point that runs a notification script.
  #
  # Implementation note: The block hook runs first (ordered by
  # definition order in the hooks array). If the pipeline is
  # halted by the block, subsequent hooks at the same point
  # may or may not run depending on engine configuration.
  #
  # Alternative: Use a custom exec_script that both blocks AND
  # sends a webhook notification in a single script.
  # See: hooks/block-and-notify.sh
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  # Combined block + notify script (recommended approach)
  - point:
      - turn:tool:pre
      - subagent:tool:pre
    match:
      tool: exec
      commandPattern: "rm\\s+-[rRfF]"
    action: exec_script
    target: "hooks/block-and-notify.sh"
    onFailure:
      action: block
      notifyUser: true
      message: "ðŸš« Blocked: Destructive rm detected and team notified."

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # NOTIFY: Cron job executed
  #
  # Fires before and after each cron job. The HOOK_CRON_JOB
  # env var contains the job name.
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - point: cron:post
    action: exec_script
    target: "hooks/notify-slack.sh"
    onFailure:
      action: continue

  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  # LOG: All events locally (for debugging webhook issues)
  #
  # Keep a local log alongside webhook notifications so you can
  # debug failures without losing the event data.
  # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  - point:
      - turn:post
      - subagent:spawn:pre
      - subagent:post
      - cron:post
    action: log
    target: "memory/logs/webhook-events.jsonl"
    onFailure:
      action: continue
